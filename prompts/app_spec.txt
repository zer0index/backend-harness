# Task Management API Specification

## Overview

Build a production-ready RESTful API for a task management system with user management, task CRUD operations, assignment workflows, priorities, due dates, and status tracking. The API should follow REST best practices, include comprehensive validation, proper error handling, and be fully documented via OpenAPI/Swagger.

## Technology Stack

- **Framework:** FastAPI (Python 3.11+)
- **Database:** PostgreSQL 15+ (via Docker)
- **ORM:** SQLAlchemy 2.0 (async)
- **Migrations:** Alembic
- **Authentication:** Mock authentication (swappable for JWT later)
- **Testing:** pytest + pytest-asyncio + httpx
- **Validation:** Pydantic v2
- **Documentation:** Auto-generated OpenAPI (FastAPI built-in)

## Authentication

**Current Implementation:** Mock authentication
- All requests automatically authenticated as test user
- `Authorization` header accepted but not validated
- Always returns mock user: `{"id": 1, "email": "test@example.com", "name": "Test User", "role": "admin"}`

**Future Implementation:** JWT tokens with proper authentication
- The auth dependency is structured to be easily swappable
- See `app/dependencies/auth.py` for implementation

## Core Resources

### 1. Users

**Model Fields:**
- `id` (integer, primary key)
- `email` (string, unique, indexed, required)
- `name` (string, required)
- `role` (enum: "admin", "manager", "user", default: "user")
- `is_active` (boolean, default: true)
- `created_at` (datetime, auto)
- `updated_at` (datetime, auto)

**Endpoints:**
- `GET /api/v1/users` - List users (pagination, filters)
- `POST /api/v1/users` - Create new user
- `GET /api/v1/users/{id}` - Get user details
- `PUT /api/v1/users/{id}` - Update user
- `DELETE /api/v1/users/{id}` - Soft delete user (set is_active=false)
- `GET /api/v1/users/me` - Get current authenticated user

**Business Rules:**
- Email must be unique and valid format
- Only admins can create/delete users
- Users can update their own profile
- Cannot delete user if they have active assigned tasks
- Role changes require admin permission

**Validation:**
- Email: valid format, max 255 chars
- Name: 1-100 characters, no special characters except spaces, hyphens, apostrophes
- Role: must be one of ["admin", "manager", "user"]

### 2. Tasks

**Model Fields:**
- `id` (integer, primary key)
- `title` (string, required)
- `description` (text, optional)
- `status` (enum: "pending", "in_progress", "completed", "cancelled", default: "pending")
- `priority` (enum: "low", "medium", "high", "urgent", default: "medium")
- `assignee_id` (integer, foreign key to users, optional)
- `creator_id` (integer, foreign key to users, required)
- `due_date` (datetime, optional)
- `completed_at` (datetime, nullable)
- `created_at` (datetime, auto)
- `updated_at` (datetime, auto)

**Relationships:**
- Belongs to assignee (User)
- Belongs to creator (User)
- Has many tags (many-to-many through task_tags)

**Endpoints:**
- `GET /api/v1/tasks` - List tasks (pagination, filters, sorting)
- `POST /api/v1/tasks` - Create new task
- `GET /api/v1/tasks/{id}` - Get task details
- `PUT /api/v1/tasks/{id}` - Update task
- `DELETE /api/v1/tasks/{id}` - Delete task
- `PATCH /api/v1/tasks/{id}/status` - Update task status only
- `PATCH /api/v1/tasks/{id}/assign` - Assign task to user
- `POST /api/v1/tasks/bulk-update` - Bulk update task statuses

**Business Rules:**
- Only task creator or assigned user can update task
- Admins can update any task
- Cannot assign task to inactive users
- Setting status to "completed" auto-sets `completed_at` timestamp
- Cannot set due_date in the past when creating tasks
- Cannot delete tasks with status "in_progress"
- Priority "urgent" tasks cannot be assigned "pending" status

**Validation:**
- Title: 1-200 characters, required
- Description: max 5000 characters
- Status: must be one of the enum values
- Priority: must be one of the enum values
- due_date: must be valid ISO datetime, future dates only for new tasks
- assignee_id: must reference existing active user

**Filters (GET /api/v1/tasks):**
- `status` - filter by status
- `priority` - filter by priority
- `assignee_id` - filter by assigned user
- `creator_id` - filter by creator
- `due_before` - tasks due before date
- `due_after` - tasks due after date
- `is_overdue` - boolean, tasks past due date
- `search` - search in title and description

**Sorting:**
- `sort_by` - field to sort by (created_at, due_date, priority, status)
- `sort_order` - asc or desc

**Pagination:**
- `page` - page number (default: 1)
- `page_size` - items per page (default: 20, max: 100)

### 3. Tags

**Model Fields:**
- `id` (integer, primary key)
- `name` (string, unique, required)
- `color` (string, hex color, optional)
- `created_at` (datetime, auto)

**Relationships:**
- Has many tasks (many-to-many through task_tags)

**Endpoints:**
- `GET /api/v1/tags` - List all tags
- `POST /api/v1/tags` - Create new tag
- `GET /api/v1/tags/{id}` - Get tag details with task count
- `PUT /api/v1/tags/{id}` - Update tag
- `DELETE /api/v1/tags/{id}` - Delete tag (removes from tasks)

**Business Rules:**
- Tag names must be unique (case-insensitive)
- Deleting a tag removes it from all tasks
- Cannot create tag with same name as existing (case-insensitive match)

**Validation:**
- Name: 1-50 characters, alphanumeric + spaces/hyphens
- Color: valid hex color (e.g., "#FF5733") or null

### 4. Task Tags (Junction Table)

**Model Fields:**
- `task_id` (integer, foreign key to tasks)
- `tag_id` (integer, foreign key to tags)
- `created_at` (datetime, auto)

**Endpoints:**
- `POST /api/v1/tasks/{id}/tags` - Add tags to task (array of tag IDs)
- `DELETE /api/v1/tasks/{id}/tags/{tag_id}` - Remove tag from task
- `GET /api/v1/tasks/{id}/tags` - List task's tags

### 5. Comments

**Model Fields:**
- `id` (integer, primary key)
- `task_id` (integer, foreign key to tasks, required)
- `user_id` (integer, foreign key to users, required)
- `content` (text, required)
- `created_at` (datetime, auto)
- `updated_at` (datetime, auto)

**Endpoints:**
- `GET /api/v1/tasks/{task_id}/comments` - List comments for task
- `POST /api/v1/tasks/{task_id}/comments` - Add comment to task
- `PUT /api/v1/comments/{id}` - Update comment (own comments only)
- `DELETE /api/v1/comments/{id}` - Delete comment (own comments or admin)

**Business Rules:**
- Users can only edit/delete their own comments
- Admins can delete any comment
- Cannot add comments to completed or cancelled tasks

**Validation:**
- Content: 1-2000 characters, required

## Error Handling

All errors should return consistent JSON format:

```json
{
  "detail": "Human-readable error message",
  "error_code": "VALIDATION_ERROR",
  "field_errors": {
    "email": ["Invalid email format"]
  }
}
```

**HTTP Status Codes:**
- `200` - Success (GET, PUT)
- `201` - Created (POST)
- `204` - No Content (DELETE)
- `400` - Bad Request (invalid data)
- `401` - Unauthorized (missing/invalid auth)
- `403` - Forbidden (insufficient permissions)
- `404` - Not Found (resource doesn't exist)
- `409` - Conflict (duplicate email, etc.)
- `422` - Validation Error (Pydantic validation failures)
- `500` - Internal Server Error

## Pagination Format

All list endpoints return:

```json
{
  "items": [...],
  "total": 100,
  "page": 1,
  "page_size": 20,
  "total_pages": 5
}
```

## Database Schema

**Tables:**

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    name VARCHAR(100) NOT NULL,
    role VARCHAR(20) NOT NULL DEFAULT 'user',
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE tasks (
    id SERIAL PRIMARY KEY,
    title VARCHAR(200) NOT NULL,
    description TEXT,
    status VARCHAR(20) NOT NULL DEFAULT 'pending',
    priority VARCHAR(20) NOT NULL DEFAULT 'medium',
    assignee_id INTEGER REFERENCES users(id),
    creator_id INTEGER NOT NULL REFERENCES users(id),
    due_date TIMESTAMP,
    completed_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE tags (
    id SERIAL PRIMARY KEY,
    name VARCHAR(50) UNIQUE NOT NULL,
    color VARCHAR(7),
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE task_tags (
    task_id INTEGER NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,
    tag_id INTEGER NOT NULL REFERENCES tags(id) ON DELETE CASCADE,
    created_at TIMESTAMP DEFAULT NOW(),
    PRIMARY KEY (task_id, tag_id)
);

CREATE TABLE comments (
    id SERIAL PRIMARY KEY,
    task_id INTEGER NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,
    user_id INTEGER NOT NULL REFERENCES users(id),
    content TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_tasks_assignee ON tasks(assignee_id);
CREATE INDEX idx_tasks_creator ON tasks(creator_id);
CREATE INDEX idx_tasks_status ON tasks(status);
CREATE INDEX idx_tasks_due_date ON tasks(due_date);
CREATE INDEX idx_comments_task ON comments(task_id);
CREATE INDEX idx_users_email ON users(email);
```

## API Documentation

FastAPI automatically generates OpenAPI documentation available at:
- `/docs` - Swagger UI (interactive API testing)
- `/redoc` - ReDoc (alternative documentation view)
- `/openapi.json` - OpenAPI schema JSON

## Testing Requirements

### Test Categories

1. **Endpoint Tests** - HTTP request/response validation
   - Test all CRUD operations
   - Verify status codes
   - Validate response schemas
   - Test error cases (400, 404, 422, etc.)

2. **Model Tests** - Database model behavior
   - Test model creation and relationships
   - Verify constraints (unique, foreign keys)
   - Test cascade deletes
   - Validate default values

3. **Business Logic Tests** - Service layer rules
   - Test permission checks
   - Validate business rules
   - Test edge cases and boundaries
   - Verify state transitions

4. **Integration Tests** - Cross-feature workflows
   - Create user → Create task → Assign task → Complete task
   - Test complex filtering and sorting
   - Verify pagination works correctly
   - Test bulk operations

5. **Edge Case Tests** - Error handling and limits
   - Invalid data types
   - Missing required fields
   - Out-of-range values
   - Duplicate constraints
   - Concurrent updates

### Test Coverage Goals
- Overall coverage: >80%
- Critical paths (CRUD operations): 100%
- Business logic functions: >90%

## Success Criteria

### Functionality
- All CRUD operations work correctly
- Validation catches invalid input
- Business rules are enforced
- Relationships work properly
- Filters and pagination function correctly
- Error handling is comprehensive

### Code Quality
- Clean, maintainable code structure
- Proper separation of concerns (models, schemas, services, routers)
- Type hints throughout
- Comprehensive docstrings
- No code duplication

### Testing
- All endpoints have test coverage
- Both happy path and error cases tested
- Integration tests cover workflows
- Tests run fast (<5 seconds for full suite)

### Documentation
- OpenAPI spec is accurate and complete
- All endpoints documented
- Request/response schemas clear
- Error responses documented

### Performance
- Database queries optimized (no N+1 queries)
- Proper indexing on foreign keys and filter fields
- Pagination prevents large result sets
- Response times <100ms for simple queries

## Project Structure

```
project/
├── app/
│   ├── __init__.py
│   ├── main.py                 # FastAPI app
│   ├── config.py               # Settings
│   ├── database.py             # DB connection
│   ├── models/
│   │   ├── __init__.py
│   │   ├── base.py            # Base model
│   │   ├── user.py
│   │   ├── task.py
│   │   ├── tag.py
│   │   └── comment.py
│   ├── schemas/
│   │   ├── __init__.py
│   │   ├── user.py            # User Pydantic models
│   │   ├── task.py
│   │   ├── tag.py
│   │   ├── comment.py
│   │   └── common.py          # Pagination, etc.
│   ├── routers/
│   │   ├── __init__.py
│   │   └── v1/
│   │       ├── __init__.py
│   │       ├── users.py
│   │       ├── tasks.py
│   │       ├── tags.py
│   │       └── comments.py
│   ├── services/
│   │   ├── __init__.py
│   │   ├── user_service.py
│   │   ├── task_service.py
│   │   ├── tag_service.py
│   │   └── comment_service.py
│   └── dependencies/
│       ├── __init__.py
│       ├── auth.py            # Mock auth
│       └── database.py        # DB session
├── tests/
│   ├── __init__.py
│   ├── conftest.py            # Pytest fixtures
│   ├── api/
│   │   └── v1/
│   │       ├── test_users.py
│   │       ├── test_tasks.py
│   │       ├── test_tags.py
│   │       └── test_comments.py
│   ├── services/
│   │   ├── test_user_service.py
│   │   └── test_task_service.py
│   └── integration/
│       └── test_workflows.py
├── alembic/
│   ├── env.py
│   └── versions/
├── docker-compose.yml
├── alembic.ini
├── pyproject.toml
├── .env.example
├── feature_list.json
├── init.sh
└── README.md
```

## Implementation Priority

Implement features in this order:

1. **Foundation** (Session 1)
   - Project structure
   - Database setup (PostgreSQL + Alembic)
   - Mock authentication
   - Base models and schemas

2. **Users API** (Sessions 2-3)
   - User CRUD endpoints
   - User validation and business rules
   - User tests

3. **Tasks API** (Sessions 4-8)
   - Task CRUD endpoints
   - Task status management
   - Task assignment
   - Task filtering and sorting
   - Pagination
   - Task tests

4. **Tags API** (Sessions 9-10)
   - Tag CRUD endpoints
   - Task-tag relationships
   - Tag tests

5. **Comments API** (Sessions 11-12)
   - Comment CRUD endpoints
   - Comment permissions
   - Comment tests

6. **Polish** (Session 13+)
   - Integration tests
   - Performance optimization
   - Documentation review
   - Error handling improvements
